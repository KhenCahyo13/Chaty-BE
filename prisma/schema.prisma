// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum MessageType {
  TEXT
  AUDIO
  FILE
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username  String   @unique @db.VarChar(100)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  profile                     UserProfile?
  ownedGroups                 Group[]
  groupMembers                GroupMember[]
  groupMessages               GroupMessage[]
  privateConversationsAsUser1 PrivateConversation[] @relation("PrivateConversationUser1")
  privateConversationsAsUser2 PrivateConversation[] @relation("PrivateConversationUser2")
  privateMessages             PrivateMessage[]
  privateMessageReads         PrivateMessageRead[]
  pushTokens                  UserPushToken[]

  @@map("users")
}

model UserPushToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  fcmToken   String   @map("fcm_token") @db.Text
  platform   String   @db.VarChar(20)
  deviceId   String?  @map("device_id") @db.VarChar(255)
  isActive   Boolean  @default(true) @map("is_active")
  lastSeenAt DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId, isActive])
  @@index([fcmToken])
  @@index([deviceId])
  @@map("user_push_tokens")
}

model UserProfile {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  fullName  String   @map("full_name") @db.VarChar(255)
  about     String?  @db.VarChar(100)
  avatarUrl String?  @map("avatar_url") @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("user_profiles")
}

model PrivateConversation {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user1Id   String   @map("user_1_id") @db.Uuid
  user2Id   String   @map("user_2_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  user1    User             @relation("PrivateConversationUser1", fields: [user1Id], references: [id], onUpdate: Cascade, onDelete: Cascade)
  user2    User             @relation("PrivateConversationUser2", fields: [user2Id], references: [id], onUpdate: Cascade, onDelete: Cascade)
  messages PrivateMessage[]

  @@unique([user1Id, user2Id])
  @@map("private_conversations")
}

model Group {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId     String   @map("owner_id") @db.Uuid
  name        String   @db.VarChar(150)
  description String?  @db.Text
  avatarUrl   String?  @map("avatar_url") @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  owner    User           @relation(fields: [ownerId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  members  GroupMember[]
  messages GroupMessage[]

  @@map("groups")
}

model GroupMember {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId    String   @map("group_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  isAdmin    Boolean  @default(false) @map("is_admin")
  joinedAt   DateTime @default(now()) @map("joined_at") @db.Timestamptz(6)
  lastReadAt DateTime @default(now()) @map("last_read_at") @db.Timestamptz(6)

  group Group @relation(fields: [groupId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model GroupMessage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  senderId  String   @map("sender_id") @db.Uuid
  content   String?  @db.Text
  isDeleted Boolean  @default(false) @map("is_deleted")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  group       Group                    @relation(fields: [groupId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  sender      User                     @relation(fields: [senderId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  attachments GroupMessageAttachment[]

  @@map("group_messages")
}

model GroupMessageAttachment {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId String @map("message_id") @db.Uuid
  fileName  String @map("file_name") @db.VarChar(255)
  fileUrl   String @map("file_url") @db.Text
  fileType  String @map("file_type") @db.Char(10)
  fileSize  BigInt @map("file_size") @db.BigInt

  message GroupMessage @relation(fields: [messageId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("group_message_attachments")
}

model PrivateMessage {
  id                    String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  privateConversationId String      @map("private_conversation_id") @db.Uuid
  senderId              String      @map("sender_id") @db.Uuid
  messageType           MessageType @default(TEXT) @map("message_type")
  content               String?     @db.Text
  isDeleted             Boolean     @default(false) @map("is_deleted")
  createdAt             DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime    @default(now()) @map("updated_at") @db.Timestamptz(6)

  conversation PrivateConversation        @relation(fields: [privateConversationId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  sender       User                       @relation(fields: [senderId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  attachments  PrivateMessageAttachment[]
  reads        PrivateMessageRead[]

  @@map("private_messages")
}

model PrivateMessageAttachment {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId String @map("message_id") @db.Uuid
  fileName  String @map("file_name") @db.VarChar(255)
  fileUrl   String @map("file_url") @db.Text
  fileType  String @map("file_type") @db.Char(10)
  fileSize  BigInt @map("file_size") @db.BigInt

  message PrivateMessage @relation(fields: [messageId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("private_message_attachments")
}

model PrivateMessageRead {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId  String   @map("message_id") @db.Uuid
  receiverId String   @map("receiver_id") @db.Uuid
  readAt     DateTime @map("read_at") @db.Timestamptz(6)

  message  PrivateMessage @relation(fields: [messageId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  receiver User           @relation(fields: [receiverId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([messageId, receiverId])
  @@map("private_message_reads")
}
